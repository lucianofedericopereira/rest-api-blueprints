openapi: "3.1.0"

info:
  title: ISO 27001 Spring Boot Blueprint
  version: "1.0.0"
  description: |
    Reference REST API implementing ISO 27001 security controls.
    Built with Spring Boot 3, JPA/PostgreSQL, Redis, and AWS integrations.
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:8082
    description: Local development

tags:
  - name: auth
    description: Authentication and token management (A.9)
  - name: users
    description: User management (A.9)
  - name: health
    description: Liveness, readiness, and diagnostics (A.17)

paths:
  /api/v1/auth/login:
    post:
      operationId: login
      summary: Authenticate and issue JWT pair
      description: >
        Validates credentials and returns a short-lived access token (30 min) and a
        long-lived refresh token (7 days). Rate-limited to 10 requests/min per IP.
        Brute-force locked after 5 consecutive failures for 15 minutes (A.9).
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        "200":
          description: Token pair issued
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPair"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"

  /api/v1/auth/refresh:
    post:
      operationId: refreshToken
      summary: Exchange refresh token for a new token pair
      description: >
        Issues a new access + refresh token pair and immediately revokes the
        submitted refresh token (rotation). Rate-limited to 10 requests/min per IP (A.9).
      tags: [auth]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: New token pair issued
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPair"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"

  /api/v1/auth/logout:
    post:
      operationId: logout
      summary: Logout (stateless JWT â€” client-side token discard)
      description: >
        Acknowledges logout. In stateless JWT mode the client must discard the token.
        Server-side token revocation is applied if a token blocklist is configured (A.9).
      tags: [auth]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Logout acknowledged
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"

  /api/v1/users:
    post:
      operationId: createUser
      summary: Register a new user (public)
      description: >
        Public endpoint to create a new user account. Password is hashed with bcrypt
        cost 12 before storage (A.10). Rate-limited to 30 write requests/min per IP (A.9).
      tags: [users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
      responses:
        "201":
          description: User created
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "429":
          $ref: "#/components/responses/TooManyRequests"
    get:
      operationId: listUsers
      summary: List all users (admin only)
      description: >
        Returns a paginated list of all active users. Restricted to the admin role (A.9).
        Rate-limited to 100 requests/min per IP.
      tags: [users]
      security:
        - BearerAuth: []
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        "200":
          description: Paginated user list
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/users/me:
    get:
      operationId: getCurrentUser
      summary: Get current authenticated user profile
      description: >
        Returns the profile of the currently authenticated user. Email is returned
        decrypted from AES-256-GCM storage (A.10).
      tags: [users]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current user profile
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/users/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      operationId: getUser
      summary: Get a specific user (owner or admin)
      description: >
        Returns a user profile. Accessible by the account owner or any admin.
        Enforces RBAC ownership check (A.9).
      tags: [users]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      operationId: updateUser
      summary: Update user profile (owner or admin)
      description: >
        Partially updates a user profile. Accessible by the account owner or any admin.
        All changes are recorded in the immutable audit_logs table (A.12).
        Rate-limited to 30 write requests/min per IP (A.9).
      tags: [users]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdate"
      responses:
        "200":
          description: Updated user profile
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/X-RateLimit-Limit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/X-RateLimit-Remaining"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteUser
      summary: Delete user (admin only)
      description: >
        Soft-deletes a user (sets deleted_at, preserves audit trail). Restricted to
        the admin role. The deletion is recorded in audit_logs (A.12).
        Rate-limited to 30 write requests/min per IP (A.9).
      tags: [users]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: User soft-deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/health/live:
    get:
      operationId: healthLive
      summary: Liveness probe
      description: >
        Returns 200 if the process is alive. No dependency checks performed.
        Suitable for Kubernetes liveness probes (A.17).
      tags: [health]
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthLive"

  /api/v1/health/ready:
    get:
      operationId: healthReady
      summary: Readiness probe (DB connectivity)
      description: >
        Returns 200 only if the database and cache are reachable. Returns 503 if any
        dependency is unavailable. Suitable for Kubernetes readiness probes (A.17).
      tags: [health]
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthReady"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

  /api/v1/health/detail:
    get:
      operationId: healthDetailed
      summary: Full telemetry and diagnostics (admin only)
      description: >
        Returns full telemetry: error budget remaining, quality score, uptime, and
        component status. Restricted to the admin role (A.17).
      tags: [health]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Full diagnostics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthDetailed"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  headers:
    X-RateLimit-Limit:
      description: Maximum requests allowed in the current window
      schema:
        type: integer
    X-RateLimit-Remaining:
      description: Requests remaining in the current window
      schema:
        type: integer

  schemas:
    TokenPair:
      type: object
      required: [access_token, refresh_token, token_type]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
          enum: [bearer]

    UserCreate:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 12
        fullName:
          type: string
        role:
          type: string
          enum: [ADMIN, MANAGER, ANALYST, VIEWER]

    UserUpdate:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 12
        fullName:
          type: string
        role:
          type: string
          enum: [ADMIN, MANAGER, ANALYST, VIEWER]

    User:
      type: object
      required: [id, email, role, isActive, createdAt]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        fullName:
          type: string
        role:
          type: string
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time

    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string

    HealthLive:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ok]

    HealthReady:
      type: object
      required: [status, checks]
      properties:
        status:
          type: string
          enum: [ok, degraded]
        checks:
          type: object
          additionalProperties:
            type: string

    HealthDetailed:
      type: object
      required: [status]
      properties:
        status:
          type: string
        java_version:
          type: string
        error_budget_remaining_pct:
          type: number
        quality_score:
          type: number

  responses:
    BadRequest:
      description: Invalid request body or parameters
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Forbidden:
      description: Insufficient role permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Conflict:
      description: Resource already exists
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    TooManyRequests:
      description: Rate limit or brute-force lockout exceeded
      headers:
        X-RateLimit-Limit:
          $ref: "#/components/headers/X-RateLimit-Limit"
        X-RateLimit-Remaining:
          $ref: "#/components/headers/X-RateLimit-Remaining"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    ServiceUnavailable:
      description: Service dependency is unavailable
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
