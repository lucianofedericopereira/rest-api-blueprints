# Infrastructure — AWS Terraform

Plain Terraform HCL modules for deploying all seven REST API blueprint stacks
to AWS using ECS Fargate. Every resource is tagged, all secrets live in
Secrets Manager, and each ISO 27001 control is cross-referenced in comments.

---

## Prerequisites

| Tool | Version |
|------|---------|
| Terraform | ≥ 1.8 |
| AWS CLI | ≥ 2.x (configured with credentials) |
| Docker | for `docker build` + `docker push` to ECR |

---

## Directory Structure

```
terraform/
├── modules/
│   ├── vpc/           Shared VPC, subnets, IGW, NAT, security groups
│   ├── rds/           RDS PostgreSQL 16 — encrypted, automated backups
│   ├── elasticache/   ElastiCache Redis 7 — in-transit + at-rest encryption
│   ├── secrets/       Secrets Manager — one secret JSON blob per stack
│   ├── ecr/           ECR repository — immutable tags, scan on push
│   └── ecs-service/   ECS Fargate service + IAM + CloudWatch log group + ALB rule
└── environments/
    └── staging/       Root module wiring all 7 stacks
        ├── main.tf
        ├── variables.tf
        ├── outputs.tf
        └── terraform.tfvars.example
```

---

## Quick Start

```bash
# 1. Copy and edit the example tfvars
cp infra/terraform/environments/staging/terraform.tfvars.example \
   infra/terraform/environments/staging/terraform.tfvars
# Edit terraform.tfvars — fill in domain, certificate_arn, and all secret values

# 2. Initialise (configure S3 backend in main.tf first)
cd infra/terraform/environments/staging
terraform init

# 3. Preview changes
terraform plan -out=staging.tfplan

# 4. Apply
terraform apply staging.tfplan
```

> **Note:** The first apply provisions the RDS instance. After it completes,
> retrieve the generated master password from Secrets Manager and set each
> stack's `DATABASE_URL` accordingly, then re-apply.

---

## Module Reference

### `modules/vpc`

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `project` | string | — | Project name prefix |
| `environment` | string | — | Deployment environment |
| `vpc_cidr` | string | `10.0.0.0/16` | VPC CIDR block |
| `public_subnet_cidrs` | list(string) | `["10.0.1.0/24","10.0.2.0/24"]` | Public subnets for ALB |
| `private_subnet_cidrs` | list(string) | `["10.0.11.0/24","10.0.12.0/24"]` | Private subnets for ECS/RDS/Redis |
| `availability_zones` | list(string) | `["us-east-1a","us-east-1b"]` | AZs to spread across |

**Outputs:** `vpc_id`, `public_subnet_ids`, `private_subnet_ids`, `alb_sg_id`, `ecs_sg_id`, `rds_sg_id`, `redis_sg_id`

### `modules/rds`

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `identifier` | string | — | RDS instance identifier |
| `db_name` | string | — | Initial database name |
| `instance_class` | string | `db.t3.micro` | RDS instance class |
| `allocated_storage` | number | `20` | Storage in GiB |
| `deletion_protection` | bool | `true` | Prevent accidental deletion |

Master password auto-generated by Terraform and stored in Secrets Manager.

**Outputs:** `endpoint`, `port`, `db_name`, `secret_arn`

### `modules/elasticache`

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `node_type` | string | `cache.t3.micro` | ElastiCache node type |
| `num_cache_clusters` | number | `1` | Replicas (≥2 enables failover) |

Auth token auto-generated and stored in Secrets Manager.

**Outputs:** `primary_endpoint`, `port`, `auth_token_secret_arn`, `redis_url_template`

### `modules/secrets`

| Variable | Type | Description |
|----------|------|-------------|
| `secret_values` | map(string) | Key/value pairs stored as JSON |
| `recovery_window_days` | number | Days before permanent deletion (default: 7) |

**Outputs:** `secret_arn`, `secret_name`

### `modules/ecr`

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `image_tag_mutability` | string | `IMMUTABLE` | Prevent tag overwrites |
| `max_image_count` | number | `10` | Lifecycle policy: keep last N tagged images |

**Outputs:** `repository_url`, `repository_arn`, `registry_id`

### `modules/ecs-service`

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `container_port` | number | — | Port the app listens on |
| `cpu` | number | `256` | Fargate CPU units |
| `memory` | number | `512` | Fargate memory (MiB) |
| `desired_count` | number | `1` | Task replicas |
| `env_vars` | map(string) | `{}` | Non-secret environment variables |
| `host_header` | string | — | ALB host-based routing value |
| `health_check_path` | string | `/api/v1/health/live` | ALB health check path |
| `log_retention_days` | number | `365` | CloudWatch log retention |

Secrets are injected at runtime via the `secrets:` block in the task definition.
The plaintext value is never stored in the task definition JSON.

**Outputs:** `service_name`, `task_definition_arn`, `task_execution_role_arn`, `task_role_arn`, `log_group_name`, `target_group_arn`

---

## Container Ports

| Stack | Port | Host Header |
|-------|:----:|-------------|
| FastAPI | 8000 | `fastapi.{domain}` |
| NestJS | 3000 | `nestjs.{domain}` |
| Spring Boot | 8080 | `springboot.{domain}` |
| Go/Gin | 8003 | `gin.{domain}` |
| Elixir/Phoenix | 8004 | `phoenix.{domain}` |
| Symfony | 9000 | `symfony.{domain}` |
| Laravel | 9000 | `laravel.{domain}` |

---

## ISO 27001 Controls

| Control | Resource | Implementation |
|---------|---------|---------------|
| A.9 | ECS task execution IAM role | Least-privilege: reads only its own Secrets Manager secret + ECR + CloudWatch |
| A.9 | ECS task IAM role | Application process has no AWS permissions by default |
| A.9 | VPC security groups | ECS tasks only accept traffic from ALB SG; RDS/Redis only accept from ECS SG |
| A.10 | RDS | `storage_encrypted = true`; master password in Secrets Manager |
| A.10 | ElastiCache | `at_rest_encryption_enabled = true`; `transit_encryption_enabled = true`; auth token in Secrets Manager |
| A.10 | ECS task definition | Secrets injected via `secrets:` block — plaintext never stored in task definition JSON |
| A.10 | `infra/.gitignore` | `.tfstate` and `.tfvars` files excluded from git |
| A.12 | CloudWatch log groups | `retention_in_days = 365`; one group per stack |
| A.14 | ECR | `image_scanning_configuration { scan_on_push = true }`; `image_tag_mutability = IMMUTABLE` |
| A.17 | RDS | `backup_retention_period = 7`; `deletion_protection = true` |
| A.17 | ElastiCache | Replication group with `automatic_failover_enabled` when `num_cache_clusters >= 2` |
| A.17 | ECS service | `deployment_minimum_healthy_percent = 50`; `force_new_deployment = true` |

---

## Makefile Targets

```bash
make infra-fmt        # terraform fmt -recursive infra/terraform/
make infra-validate   # validate all modules + staging env
make infra-plan       # terraform plan (requires AWS credentials)
```

---

## Pushing Images to ECR

After `terraform apply`, push a stack image:

```bash
# Authenticate
aws ecr get-login-password --region us-east-1 \
  | docker login --username AWS --password-stdin \
    $(terraform -chdir=infra/terraform/environments/staging output -raw stack_ecr_urls | jq -r '.fastapi')

# Build and push
docker build -t rest-blueprints-fastapi-staging:v1.0.0 ./iso27001-fastapi
docker tag rest-blueprints-fastapi-staging:v1.0.0 \
  <account>.dkr.ecr.us-east-1.amazonaws.com/rest-blueprints-fastapi-staging:v1.0.0
docker push <account>.dkr.ecr.us-east-1.amazonaws.com/rest-blueprints-fastapi-staging:v1.0.0
```
